<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dup_indels &mdash; MDL 1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MDL
          </a>
              <div class="version">
                Version 1.4.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../ngs_pipeline.html">NGS pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_north.html">Running the pipeline at GLS North</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_south.html">Running the pipeline at GLS South</a></li>
<li class="toctree-l1"><a class="reference internal" href="../genes.html">Genes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands_ngs.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code.html">Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_data_mgmt.html">Code - Data Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code_webapps.html">Code - Webapps</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MDL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>dup_indels</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dup_indels</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: dup_indels</span>
<span class="sd">    :platform: Any</span>
<span class="sd">    :synopsis: This module performs two call for Picard to remove duplicate reads and to add header information to the BAM files so they can be analysed in the remainder of the pipeline</span>
<span class="sd">.. moduleauthor:: Paulo Nuin, December 2015</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">graypy</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">graypy_handler</span> <span class="o">=</span> <span class="n">graypy</span><span class="o">.</span><span class="n">GELFUDPHandler</span><span class="p">(</span><span class="s1">&#39;192.168.1.169&#39;</span><span class="p">,</span> <span class="mi">12201</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">graypy_handler</span><span class="p">)</span>


<div class="viewcode-block" id="remove_duplicates"><a class="viewcode-back" href="../code.html#dup_indels.remove_duplicates">[docs]</a><span class="k">def</span> <span class="nf">remove_duplicates</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">picard</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that runs the duplicate removal step in the analysis</span>

<span class="sd">    :param sample_id: ID of the patient/sample being analysed using Picard</span>
<span class="sd">    :param datadir: Location of the BAM files</span>
<span class="sd">    :param picard: Picard jar file location</span>

<span class="sd">    :type sample_id: string</span>
<span class="sd">    :type datadir: string</span>
<span class="sd">    :type picard: string</span>

<span class="sd">    :return: returns success or exists</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argument</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span>
    <span class="n">argument2</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument2</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam file exists &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;exists&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Picard - Starting duplicate removal&#39;</span><span class="p">)</span>
    <span class="n">picard_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> MarkDuplicates INPUT=</span><span class="si">%s</span><span class="s1">.bam OUTPUT=</span><span class="si">%s</span><span class="s1">.dedup.bam METRICS_FILE=</span><span class="si">%s</span><span class="s1">.metrics.txt QUIET=true&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">picard</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">picard_string</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">picard_string</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Picard - done duplicate marking &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;success&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;dedup.bam, duplicate removal failed &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;error - process&#39;</span></div>


<div class="viewcode-block" id="samtools_duplicates"><a class="viewcode-back" href="../code.html#dup_indels.samtools_duplicates">[docs]</a><span class="k">def</span> <span class="nf">samtools_duplicates</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">samtools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that runs the duplicate removal step in the analysis</span>

<span class="sd">    :param sample_id: ID of the patient/sample being analysed using Picard</span>
<span class="sd">    :param datadir: Location of the BAM files</span>
<span class="sd">    :param samtools: Picard jar file location</span>

<span class="sd">    :type sample_id: string</span>
<span class="sd">    :type datadir: string</span>
<span class="sd">    :type samtools: string</span>

<span class="sd">    :return: returns success or exists</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">argument</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span>
    <span class="n">argument2</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.pos.bam&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File removed &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File does not exist &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.fix.bam&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File removed &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File does not exist &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.sort.bam&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File removed &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File does not exist &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument2</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dedup.bam file exists &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;exists&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.sort.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Samtools - Starting duplicate removal - sort 1&#39;</span><span class="p">)</span>
        <span class="n">samtools_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> sort -n -o </span><span class="si">%s</span><span class="s1">.sort.bam </span><span class="si">%s</span><span class="s1">.bam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">samtools_string</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">samtools_string</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sort.bam file exists&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.fix.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Samtools - Duplicate removal - fix&#39;</span><span class="p">)</span>
        <span class="n">samtools_string2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> fixmate -m </span><span class="si">%s</span><span class="s1">.sort.bam </span><span class="si">%s</span><span class="s1">.fix.bam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">samtools_string2</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">samtools_string2</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fix.bam file exists&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.pos.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Samtools - Duplicate removal - sort 2&#39;</span><span class="p">)</span>
        <span class="n">samtools_string3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> sort -o </span><span class="si">%s</span><span class="s1">.pos.bam </span><span class="si">%s</span><span class="s1">.fix.bam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">samtools_string3</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">samtools_string3</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pos.bam file exists&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.dedup.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Samtools - Duplicate removal - markdup&#39;</span><span class="p">)</span>
        <span class="n">samtools_string4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> markdup </span><span class="si">%s</span><span class="s1">.pos.bam </span><span class="si">%s</span><span class="s1">.dedup.bam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">samtools_string4</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">samtools_string4</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;success&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dedup.bam file exists&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;dedup.bam, duplicate removal failed&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;error - process&#39;</span></div>


<div class="viewcode-block" id="add_groups"><a class="viewcode-back" href="../code.html#dup_indels.add_groups">[docs]</a><span class="k">def</span> <span class="nf">add_groups</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">datadir</span><span class="p">,</span> <span class="n">picard</span><span class="p">,</span> <span class="n">samtools</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function that add header groups to BAM files generated by BWA</span>

<span class="sd">    :param sample_id: ID of the patient/sample being analysed using Picard</span>
<span class="sd">    :param datadir: Location of the BAM files</span>
<span class="sd">    :param samtools: Location of the Samtools executable</span>

<span class="sd">    :type sample_id: string</span>
<span class="sd">    :type datadir: string</span>
<span class="sd">    :type samtools: string</span>

<span class="sd">    :return: returns success or exists</span>

<span class="sd">    :todo: return error</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM&#39;</span><span class="p">):</span>
        <span class="n">argument</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span>
        <span class="n">argument2</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">argument</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span>
        <span class="n">argument2</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s1">&#39;/BAM/&#39;</span> <span class="o">+</span> <span class="n">sample_id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.good.bam&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument2</span> <span class="o">+</span> <span class="s1">&#39;.good.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Good.bam file exists &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;exists&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Picard - adding groups to BAM file &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="n">picard_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> AddOrReplaceReadGroups INPUT=</span><span class="si">%s</span><span class="s1">.dedup.bam OUTPUT=</span><span class="si">%s</span><span class="s1">.good.bam RGSM=</span><span class="si">%s</span><span class="s1"> RGLB=Test RGPL=illumina RGPU=none QUIET=true&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">picard</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">picard_string</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="n">samtools_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> index </span><span class="si">%s</span><span class="s1">.good.bam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samtools</span><span class="p">,</span> <span class="n">argument</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Command &#39;</span> <span class="o">+</span> <span class="n">samtools_string</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">picard_string</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">argument</span> <span class="o">+</span> <span class="s1">&#39;.good.bam&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Picard - done adding groups &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting samtools indexing of good.bam &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">samtools_string</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;success&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding groups failed &#39;</span> <span class="o">+</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;error - adding groups failed&#39;</span></div>


<span class="c1"># if __name__ == &#39;__main__&#39;:</span>

<span class="c1">#     data_datadir = &#39;/Users/nuin/Projects/Data/Illumina_small/&#39;</span>
<span class="c1">#     sample_id = &#39;NA12877_1&#39;</span>
<span class="c1">#     remove_duplicates(sample_id, data_datadir, &#39;picard&#39;)</span>
<span class="c1">#     # add_groups(sample_id, data_datadir, &#39;picard&#39;, &#39;samtools&#39;)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2019, Paulo Nuin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>